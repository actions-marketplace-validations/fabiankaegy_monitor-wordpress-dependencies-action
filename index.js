function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("path")),n=require("@actions/core"),o=require("@actions/github"),r=require("@actions/exec"),s=e(require("fs"));require("pretty-bytes");var a=e(require("php-array-parser"));async function i(e){try{return await s.promises.access(e,s.constants.F_OK),!0}catch(e){}return!1}function c(e){if(0==e.length)return"";for(;e.every(e=>!e[e.length-1]);)for(const t of e)t.pop();const[t]=e;let n=t.length;if(3===n&&e.every(e=>"0 B"===e[2])){n-=1;for(const t of e)t.pop()}return 0===n?"":[["Filename","Dependencies","Change",""].slice(0,n),[":---",":---:",":---:",":---:"].slice(0,n),...e].map(e=>`| ${e.join(" | ")} |`).join("\n")}function l(e){return/^(1|true|yes)$/.test(e)}function u(e,t,n){return n.indexOf(e)===t}const p=require("path"),d=require("util.promisify"),g=require("glob"),m=require("minimatch"),f=(require("fs-extra"),d(g));class h{constructor(e){const t=e||{};t.pattern=t.pattern||"**/*.asset.php",t.filename=t.filename||"size-plugin.json",t.writeFile=!1!==t.writeFile,t.filepath=p.join(process.cwd(),t.filename),t.mode=t.mode||process.env.NODE_ENV,this.options=t}filterFiles(e){const t=m.filter(this.options.pattern),n=this.options.exclude?m.filter(this.options.exclude):()=>!1;return e.filter(e=>t(e)&&!n(e))}async readFromDisk(e){const t=await f(this.options.pattern,{cwd:e,ignore:this.options.exclude}),n=await Promise.all(this.filterFiles(t).map(t=>async function(e){const{dependencies:t}=await async function(e){const t=await async function(e){return(await s.promises.readFile(e)).toString()}(e),n=await async function(e){const t=e.match(/array\(.+?(?=\;)/gm);if(!t)throw new Error("Could not find asset file array");return t[0]}(t);return a.parse(n)}(e);return t}(p.join(e,t)).catch(()=>null)));return o=n,t.reduce((e,t,n)=>(e[t]=o[n],e),{});var o}async getDiff(e,t){const n=[...Object.keys(e),...Object.keys(t)].filter(u),o=[];for(const r of n){const n=t[r]||0,s=e[r]||0,a=n.filter(e=>!s.includes(e));o.push({filename:r,dependency:n.join(", "),difference:a.join(", ")})}return o}}(async()=>{try{const e=n.getInput("repo-token"),s=o.getOctokit(e);await async function(e,o,s){const{number:a}=o.issue;try{n.debug("pr"+JSON.stringify(o.payload,null,2))}catch(e){}let u,p;if("push"==o.eventName)u=o.payload.before,p=o.payload.ref,console.log(`Pushed new commit on top of ${p} (${u})`);else{if("pull_request"!=o.eventName&&"pull_request_target"!=o.eventName)throw new Error(`Unsupported eventName in github.context: ${o.eventName}. Only "pull_request", "pull_request_target", and "push" triggered workflows are currently supported.`);{const e=o.payload.pull_request;u=e.base.sha,p=e.base.ref,console.log(`PR #${a} is targeted at ${p} (${p})`)}}n.getInput("cwd")&&process.chdir(n.getInput("cwd"));const d=new h({pattern:n.getInput("pattern")||"**/dist/**/*.asset.php",exclude:n.getInput("exclude")||"{**/*.map,**/node_modules/**}"}),g=n.getInput("build-script")||"build",m=process.cwd();let f=await i(t.resolve(m,"yarn.lock")),w=await i(t.resolve(m,"pnpm-lock.yaml")),y=await i(t.resolve(m,"package-lock.json")),b="npm",k="npm install";f?(k="yarn --frozen-lockfile",b="yarn"):w?(k="pnpm install --frozen-lockfile",b="pnpm"):y&&(k="npm ci"),n.startGroup("[current] Install Dependencies"),console.log("Installing using "+k),await r.exec(k),n.endGroup(),n.startGroup("[current] Build using "+b),console.log(`Building using ${b} run ${g}`),await r.exec(`${b} run ${g}`),n.endGroup(),await r.exec("git reset --hard");const v=await d.readFromDisk(m);n.startGroup("[base] Checkout target branch");try{if(!p)throw Error("missing context.payload.pull_request.base.ref");await r.exec("git fetch -n origin "+p),console.log("successfully fetched base.ref")}catch(e){console.log("fetching base.ref failed",e.message);try{await r.exec("git fetch -n origin "+u),console.log("successfully fetched base.sha")}catch(e){console.log("fetching base.sha failed",e.message);try{await r.exec("git fetch -n")}catch(e){console.log("fetch failed",e.message)}}}console.log("checking out and building base commit");try{if(!p)throw Error("missing context.payload.base.ref");await r.exec("git reset --hard "+p)}catch(e){await r.exec("git reset --hard "+u)}n.endGroup();const x=n.getInput("clean-script");x&&(n.startGroup(`[base] Cleanup via ${b} run ${x}`),await r.exec(`${b} run ${x}`),n.endGroup()),n.startGroup("[base] Install Dependencies"),f=await i(t.resolve(m,"yarn.lock")),w=await i(t.resolve(m,"pnpm-lock.yaml")),y=await i(t.resolve(m,"package-lock.json")),b="npm",k="npm install",f?(k="yarn --frozen-lockfile",b="yarn"):w?(k="pnpm install --frozen-lockfile",b="pnpm"):y&&(k="npm ci"),console.log("Installing using "+k),await r.exec(k),n.endGroup(),n.startGroup("[base] Build using "+b),await r.exec(`${b} run ${g}`),n.endGroup(),await r.exec("git reset --hard");const _=await d.readFromDisk(m),q=await d.getDiff(_,v);n.startGroup("Size Differences:");const $=await d.printSizes(q);console.log($),n.endGroup();const G=function(e,{collapseUnchanged:t,omitUnchanged:n}){let o=[],r=[];for(const s of e){const{filename:e,size:a,delta:i}=s,c=i.length;if(c&&n)continue;const l=[`\`${e}\``,a,i];c&&t?r.push(l):o.push(l)}let s=c(o);return 0!==r.length&&(s+=`\n\n<details><summary>ℹ️ <strong>View Unchanged</strong></summary>\n\n${c(r)}\n\n</details>\n\n`),s}(q,{collapseUnchanged:l(n.getInput("collapse-unchanged")),omitUnchanged:l(n.getInput("omit-unchanged"))});let I=!1;const D={...o.repo,issue_number:a},N={...D,body:G+'\n\n<a href="https://github.com/fabiankaegy/monitor-generated-wordpress-dependencies-action"><sub>monitor-generated-wordpress-dependencies-action</sub></a>'};if("pull_request"!==o.eventName&&"pull_request_target"!==o.eventName)console.log("No PR associated with this action run. Not posting a check or comment."),I=!1;else if(l(n.getInput("use-check")))if(s){const t=await async function(e,t){const n=await e.checks.create({...t.repo,name:"Monitor Generated WordPress Dependencies",head_sha:t.payload.pull_request.head.sha,status:"in_progress"});return async o=>{await e.checks.update({...t.repo,check_run_id:n.data.id,completed_at:(new Date).toISOString(),status:"completed",...o})}}(e,o);await t({conclusion:"success",output:{title:"Monitor Generated WordPress Dependencies Action",summary:G}})}else I=!0;else{let t;n.startGroup("Updating stats PR comment");try{const n=(await e.issues.listComments(D)).data;for(let e=n.length;e--;){const o=n[e];if("Bot"===o.user.type&&/<sub>monitor-generated-wordpress-dependencies-action/.test(o.body)){t=o.id;break}}}catch(e){console.log("Error checking for previous comments: "+e.message)}if(t){console.log("Updating previous comment #"+t);try{await e.issues.updateComment({...o.repo,comment_id:t,body:N.body})}catch(e){console.log("Error editing previous comment: "+e.message),t=null}}if(!t){console.log("Creating new comment");try{await e.issues.createComment(N)}catch(t){console.log("Error creating comment: "+t.message),console.log("Submitting a PR review comment instead...");try{const t=o.issue;await e.pulls.createReview({owner:t.owner,repo:t.repo,pull_number:t.number,event:"COMMENT",body:N.body})}catch(e){console.log("Error creating PR review."),I=!0}}}n.endGroup()}I&&console.log(`\n\t\t\tError: monitor-generated-wordpress-dependencies-action was unable to comment on your PR.\n\t\t\tThis can happen for PR's originating from a fork without write permissions.\n\t\t\tYou can copy the size table directly into a comment using the markdown below:\n\t\t\t\n\n${N.body}\n\n\n\t\t`.replace(/^(\t|  )+/gm,"")),console.log("All done!")}(s,o.context,e)}catch(e){n.setFailed(e.message)}})();
